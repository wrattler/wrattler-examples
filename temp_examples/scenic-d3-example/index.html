<!doctype html>
<html>
<head>
	<title>Scenic D3 Example</title>
	<meta charset="utf-8">
	<link href='https://fonts.googleapis.com/css?family=Lora:400,700italic' rel='stylesheet' type='text/css'>
	<style>
	.info {
		padding: 6px 8px;
		font-size: 20px;
		font-family: 'Lora', serif;
		background: #fbeb3f;
		background: rgba(255,255,255,0.6);
		box-shadow: 0 0 15px rgba(0,0,0,0.2);
		border-radius: 5px;
		width:200px;
	}
	.info h4 {
		margin: 0 0 5px;
		color: #777;
		font-family: 'Lora', serif;
		font-style:  italic;
		font-weight: 700;
	}
	.legend {
		text-align: left;
		line-height: 18px;
		color: #777;
	}
	.legend i {
		width: 18px;
		height: 18px;
		float: left;
		margin-right: 8px;
		opacity: 0.7;
	}


	.band {   
		float: left;
		height: 5px;
		background-color: #c9c9c9;
	}


	body {
		font-size: 16px;
		font-family: 'Lora', serif;
	}
	b{
		font-family: 'Lora' !important;
		font-style:  italic;
		font-weight: 700;
	}

	h1 {
		margin: 0 0 5px;
		color: #000000;
		font-family: 'Lora', serif;
		font-style:  italic;
		font-weight: 700;
		font-size: 20px;
	}
	
	h3 {
	font-family: 'Lora' !important;
		font-style:  italic;
		font-weight: 700;
		color: #3a5a7d;
		text-decoration: underline; 
		font-size: 16px;
	}


	a:link {
		color: #3a5a7d;
		font-style:  italic;
	}


	a:visited {
		color: #3a5a7d;
	}


	a:hover {
		color: #3a5a7d;
		background-color: #d7d7d7;
	}


	a:active {
		color: #3a5a7d;
		background-color: #d7d7d7;
	}

	svg {
		position: relative;
	}

	html, body, #wrapper, #map {
		height: 100%;
	}
	#wrapper {
		margin-left: 260px;
	}
	#map {
		float: left;
		width: 100%;
	}
	#sidebar {
		float: left;
		width: 260px;
		margin-left: -260px;
	}
	#cleared {
		clear: both;
		
		
#faqs { position:relative; }
#faqs h3	{ cursor:pointer; }
#faqs h3.active	{ color:#d74646; }
#faqs div   { position:relative; }
#faqs div p	{ padding:0; margin-bottom:15px; }
	}
	</style>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
	<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
	<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script type="text/javascript" src="jquery1.4.js"></script>
	<script type="text/javascript">
	/* accessible */
	$(document).ready(function() {
		$('#faqs h3').each(function() {
			var tis = $(this), state = false, answer = tis.next('div').slideUp();
			tis.click(function() {
				state = !state;
				answer.slideToggle(state);
				tis.toggleClass('active',state);
			});
		});
	});
	</script>

</head>
<body>

		<div id="map"> </div>


	<script src="lsoa_simple.js"></script>
	<script>

	var now_showing=0;

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//D3 Layer start	
	d3.csv('scenicdata.csv', function (error, scenic) {
		function reformat(array) {
			var data = [];
			array.map(function (d, i) {
				data.push({
					id: i,
					type: "Feature",
					properties: {
						scenicness: d.Scenicness,
						region: d.LSOA_trim

					},
					geometry: {
						coordinates: [+d.longitude, +d.latitude],
						type: "Point"
					}
				});
			});
			return data;
		}
		var geoData = { type: "FeatureCollection", features: reformat(scenic) };

		var qtree = d3.geom.quadtree(geoData.features.map(function (data, i) {
			return {
				x: data.geometry.coordinates[0],
				y: data.geometry.coordinates[1],
				all: data
			};
		}
	)
);
// Find the nodes within the specified rectangle.
function search(quadtree, x0, y0, x3, y3) {
	var pts = [];
	var subPixel = false;
	var subPts = [];
	var scale = getZoomScale();

	var counter = 0;
	quadtree.visit(function (node, x1, y1, x2, y2) {
		var p = node.point;
		var pwidth = node.width * scale;
		var pheight = node.height * scale;
		// -- if this is too small rectangle only count the branch and set opacity
		if ((pwidth * pheight) <= 1) {
			// start collecting sub Pixel points
			subPixel = true;
		}
		// -- jumped to super node large than 1 pixel
		else {
			// end collecting sub Pixel points
			if (subPixel && subPts && subPts.length > 0) {
				subPts[0].group = subPts.length;
				pts.push(subPts[0]); // add only one todo calculate intensity
				counter += subPts.length - 1;
				subPts = [];
			}
			subPixel = false;
		}
		if ((p) && (p.x >= x0) && (p.x < x3) && (p.y >= y0) && (p.y < y3)) {
			if (subPixel) {
				subPts.push(p.all);
			}
			else {
				if (p.all.group) {
					delete (p.all.group);
				}
				pts.push(p.all);
			}
		}
		// if quad rect is outside of the search rect do nto search in sub nodes (returns true)
		return x1 >= x3 || y1 >= y3 || x2 < x0 || y2 < y0;
	});
	console.log(" Number of removed  points: " + counter);
	return pts;
}
function updateNodes(quadtree) {
	var nodes = [];
	quadtree.depth = 0; // root
	quadtree.visit(function (node, x1, y1, x2, y2) {
		var nodeRect = {
			left: MercatorXofLongitude(x1),
			right: MercatorXofLongitude(x2),
			bottom: MercatorYofLatitude(y1),
			top: MercatorYofLatitude(y2),
		}
		node.width = (nodeRect.right - nodeRect.left);
		node.height = (nodeRect.top - nodeRect.bottom);
		if (node.depth == 0) {
			console.log(" width: " + node.width + "height: " + node.height);
		}
		nodes.push(node);
		for (var i = 0; i < 4; i++) {
			if (node.nodes[i]) node.nodes[i].depth = node.depth + 1;
		}
	});
	return nodes;
}

MercatorXofLongitude = function (lon) {
	return lon * 20037508.34 / 180;
}
MercatorYofLatitude = function (lat) {
	return (Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180)) * 20037508.34 / 180;
}

var leafletMap = L.map('map').setView([51.505, -0.09], 11);
var base = new L.StamenTileLayer("toner-lite");

leafletMap.addLayer(base);


			
var customControl =  L.Control.extend({

  options: {
    position: 'topleft'
  },

  onAdd: function (map) {
    var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');



    container.onclick = function(){
		now_showing=0;
		info.update();
    }

    return container;
  }
});

leafletMap.addControl(new customControl());


var svg = d3.select(leafletMap.getPanes().overlayPane).append("svg");
var g = svg.append("g").attr("class", "leaflet-zoom-hide");
// Use Leaflet to implement a D3 geometric transformation.
function projectPoint(x, y) {
	var point = leafletMap.latLngToLayerPoint(new L.LatLng(y, x));
	this.stream.point(point.x, point.y);
}
var transform = d3.geo.transform({ point: projectPoint });
var path = d3.geo.path().projection(transform);
updateNodes(qtree);
leafletMap.on('moveend', mapmove);
mapmove();
function getZoomScale() {
	var mapWidth = leafletMap.getSize().x;
	var bounds = leafletMap.getBounds();
	var planarWidth = MercatorXofLongitude(bounds.getEast()) - MercatorXofLongitude(bounds.getWest());
	var zoomScale = mapWidth / planarWidth;
	return zoomScale;
}
function redrawSubset(subset) {
	path.pointRadius(4);// * scale);
	var bounds = path.bounds({ type: "FeatureCollection", features: subset });
	var topLeft = bounds[0];
	var bottomRight = bounds[1];
	svg.attr("width", bottomRight[0] - topLeft[0])
	.attr("height", bottomRight[1] - topLeft[1])
	.style("left", topLeft[0] + "px")
	.style("top", topLeft[1] + "px");
	g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	var start = new Date();
	var points = g.selectAll("path")
	.data(subset, function (d) {
		return d.id;
	});
	points.enter().append("path");
	points.exit().remove();
	points.attr("d", path);


	points.style("fill",function(d){ 

		return (getScenicColor(d.properties.scenicness)) }).style("fill-opacity",.80);
		console.log("updated at  " + new Date().setTime(new Date().getTime() - start.getTime()) + " ms ");
	}


	function mapmove(e) {
		var mapBounds = leafletMap.getBounds();
		subset = search(qtree, mapBounds.getWest(), mapBounds.getSouth(), mapBounds.getEast(), mapBounds.getNorth());
		//console.log("subset: " + subset.length);
		redrawSubset(subset);
	}
	
	


	function getScenicColor(d) {
		return d >= 9 ? '#012043' :
		d >= 7  ? '#0e4b8d' :
		d >= 5  ? '#7fa4b4' :
		d >= 3   ? '#cb7572' :
		d >= 1   ? '#a42e3d' :
		'#333333';
	}
	//D3 Layer End
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//Leaflet Controls
	//Stop people from zooming in or out too far
	leafletMap.options.minZoom = 10;
	leafletMap.options.maxZoom = 11;
	
	


	
	//Restrict to UK bounds
	leafletMap.setMaxBounds([
		[60.854691, 1.76896],
		[49.16209, -13.41393]
		]);
		// Fill style for rollovers
		function style(feature) {
			return {
				fillColor: '#acadc1',
				weight: 1,
				opacity: 0,
				color: 'white',
				fillOpacity: 0
			};
		}
		//load data for rollovers
		L.geoJson(UKData, {style: style}).addTo(leafletMap);
		//function for highlight
		function highlightFeature(e) {
			var layer = e.target;
			layer.setStyle({
				weight: 1,
				opacity: 1,
				color: '#acadc1',
				dashArray: '',
				fillOpacity: .2
			});
			if (!L.Browser.ie && !L.Browser.opera) {
				layer.bringToFront();
			}
			info.update(layer.feature.properties);
		}
		var geojson;
		//function for mouseout
		function resetHighlight(e) {
			geojson.resetStyle(e.target);
			info.update();
		}
		//function for click listener
		var popup = L.popup();
		//add listerners from above to map data layers
		function onEachFeature(feature, layer) {
			layer.on({
				mouseover: highlightFeature,
				mouseout: resetHighlight,
				click: displayInfo
			});
		}


		geojson = L.geoJson(UKData, {
			style: style,
			onEachFeature: onEachFeature
			}).addTo(leafletMap);
			leafletMap.attributionControl.addAttribution('Scenic Data &copy; <a href="http://scenicornot.datasciencelab.co.uk/">Scenic-Or-Not</a>');
		
		
  



			
			
				//custom info control
			var info = L.control();
			info.onAdd = function (map) {
				this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
				this.update();
				return this._div;
			};

			// method that we will use to update the control based on feature properties passed
			info.update = function (props) {


				var rollover_html="";

				if ((!props)&&(!now_showing))
				{
					rollover_html="<h4>Click on any area <br />to see region info</h4>";
				}
				else if ((!props)&&(now_showing))
				{

					rollover_html+='<b>Area: '+now_showing.geo_name+'</b><br />Scenicness<br />' 
					+ '<div class="band" style="width:'+parseInt(160-now_showing.scenicness*10*1.6)+ 'px; border-left: '+parseInt(now_showing.scenicness*10*1.6)+'px solid #a42e3d">&nbsp;</div>'
					+'Health<br />'
					+'<div class="band" style="width:'+parseInt(160-now_showing.SMR*10*1.6)+ 'px; border-left: '+parseInt(now_showing.SMR*10*1.6)+'px solid #a42e3d">&nbsp;</div>Income<br />'
					+ '<div class="band" style="width:'+parseInt(160-now_showing.income*10*1.6)+ 'px; border-left: '+parseInt(now_showing.income*10*1.6)+'px solid #a42e3d">&nbsp;</div>'
					+'Crime<br />'
					+ '<div class="band" style="width:'+parseInt(160-now_showing.crime*10*1.6)+ 'px; border-left: '+parseInt(now_showing.crime*10*1.6)+'px solid #a42e3d">&nbsp;</div>'
					+'Pollution<br />'
					+'<div class="band" style="width:'+parseInt(160-now_showing.pollution*10*1.6)+ 'px; border-left: '+parseInt(now_showing.pollution*10*1.6)+'px solid #a42e3d">&nbsp;</div>';


				}
				else if ((props)&&(!now_showing))
				{
					rollover_html+="<h4>Show info for "+props.geo_name+"</h4>";	
				}
				else
				{
					rollover_html+='<h4>Show info for ' + props.geo_name + '<br />next?</h4>';
					rollover_html+='<br /><b>Area: '+now_showing.geo_name+'</b><br />Scenicness<br />' 
					+ '<div class="band" style="width:'+parseInt(160-now_showing.scenicness*10*1.6)+ 'px; border-left: '+parseInt(now_showing.scenicness*10*1.6)+'px solid #a42e3d">&nbsp;</div>'
					+'Health<br />'
					+'<div class="band" style="width:'+parseInt(160-now_showing.SMR*10*1.6)+ 'px; border-left: '+parseInt(now_showing.SMR*10*1.6)+'px solid #a42e3d">&nbsp;</div>Income<br />'
					+ '<div class="band" style="width:'+parseInt(160-now_showing.income*10*1.6)+ 'px; border-left: '+parseInt(now_showing.income*10*1.6)+'px solid #a42e3d">&nbsp;</div>'
					+'Crime<br />'
					+ '<div class="band" style="width:'+parseInt(160-now_showing.crime*10*1.6)+ 'px; border-left: '+parseInt(now_showing.crime*10*1.6)+'px solid #a42e3d">&nbsp;</div>'
					+'Pollution<br />'
					+'<div class="band" style="width:'+parseInt(160-now_showing.pollution*10*1.6)+ 'px; border-left: '+parseInt(now_showing.pollution*10*1.6)+'px solid #a42e3d">&nbsp;</div>';

				}

				this._div.innerHTML =  rollover_html;
			};




			info.addTo(leafletMap);
			//legend	
			var legend = L.control({position: 'bottomright'});
			legend.onAdd = function (map) {
				var div = L.DomUtil.create('div', 'info legend'),
				grades = [0,2,4,6,8],
				label_text = ["1,2","3,4","5,6","7,8","9,10"]
				labels = ['Scenic Ratings<br/>'];
				for (var i = 0; i < 5; i++) {
					labels.push(
						'<i style="background:' + getScenicColor(grades[i] + 1) + '"></i> ' + label_text[i]	);
					}
					div.innerHTML = labels.join('<br>');
					return div;
				};
				legend.addTo(leafletMap);
				
			
				function displayInfo(e) {

					var layer = e.target;

					now_showing=layer.feature.properties;
					info.update(layer.feature.properties);

				
				}
	
				function getScenicIndex(d) {
					return d >= 7.8 ? 4 :
					d >= 7.21 ? 3 :
					d >= 6.43  ? 2 :
					d >= 4   ? 1 :
					d >= 1   ? 0 :
					-1;
				}


				function getHealthIndex(d) {
					return d >= 7.8 ? 4 :
					d >= 7.21 ? 3 :
					d >= 6.43  ? 2 :
					d >= 4   ? 1 :
					d >= 1   ? 0 :
					-1;
				}


				function getIncomeIndex(d) {
					return d >= 9.24 ? 4 :
					d >= 8.67 ? 3 :
					d >= 7.16  ? 2 :
					d >= 6   ? 1 :
					d >= 1   ? 0 :
					-1;
				}



				function getCrimeIndex(d) {
					return d >= 5.56 ? 4 :
					d >= 4.58 ? 3 :
					d >= 3.8  ? 2 :
					d >= 3.2   ? 1 :
					d >= 1   ? 0 :
					-1;
				}




				function getPollutionIndex(d) {
					return d >= 5.77 ? 4 :
					d >= 5.14 ? 3 :
					d >= 4.46  ? 2 :
					d >= 3.52   ? 1 :
					d >= 1   ? 0 :
					-1;
				}




			});
			
	

			
			</script>
		</body>
		</html>