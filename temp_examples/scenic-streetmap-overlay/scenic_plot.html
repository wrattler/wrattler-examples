<!doctype html>
<html>
  <head>
    <title>Scenic Ratings of London</title>
    <meta charset="utf-8">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700italic' rel='stylesheet' type='text/css'>
    <style>
      .info {
	  padding: 6px 8px;
	  font-size: 20px;
	  font-family: 'Lora', serif;
	  background: #fbeb3f;
	  background: rgba(255,255,255,0.6);
	  box-shadow: 0 0 15px rgba(0,0,0,0.2);
	  border-radius: 5px;
	  width:200px;
      }
      .info h4 {
	  margin: 0 0 5px;
	  color: #777;
	  font-family: 'Lora', serif;
	  font-style:  italic;
	  font-weight: 700;
      }
      .legend {
	  text-align: center;
	  line-height: 32px;
	  color: #777;
          height: 102px;
      }
      .legend i {
	  width: 18px;
	  height: 18px;
	  float: left;
	  margin-right: 8px;
	  opacity: 0.7;
      }
      .band {
	  float: left;
	  height: 5px;
	  background-color: #c9c9c9;
      }
      body {
	  font-size: 16px;
	  font-family: 'Lora', serif;
      }
      b {
	  font-family: 'Lora' !important;
	  font-style:  italic;
	  font-weight: 700;
      }
      h1 {
	  margin: 0 0 5px;
	  color: #000000;
	  font-family: 'Lora', serif;
	  font-style:  italic;
	  font-weight: 700;
	  font-size: 20px;
      }	
      h3 {
	  font-family: 'Lora' !important;
	  font-style:  italic;
	  font-weight: 700;
	  color: #3a5a7d;
	  text-decoration: underline; 
	  font-size: 16px;
      }
      a:link {
	  color: #3a5a7d;
	  font-style:  italic;
      }
      a:visited {
	  color: #3a5a7d;
      }
      a:hover {
	  color: #3a5a7d;
	  background-color: #d7d7d7;
      }
      a:active {
	  color: #3a5a7d;
	  background-color: #d7d7d7;
      }
      svg {
	  position: relative;
      }
      html, body, #wrapper, #map {
	  height: 100%;
      }
      #wrapper {
	  margin-left: 260px;
      }
      #map {
	  float: left;
	  width: 100%;
      }
      #sidebar {
	  float: left;
	  width: 260px;
	  margin-left: -260px;
      }
    </style>

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

  </head>
  <body>

    <div id="map"> </div>

    <script>

      function percToColour(perc, min, max) {
	/**
	 * Min-max feature scaling: scale a percentage to be between 0-100
	 * and return according hex colour, rendering from red to yellow to green. 
	 *
	 * @param  {Number} perc Percentage to scale
	 * @param  {Number} min  Minimum perc value
	 * @param  {Number} max  Maximum perc value
	 * @return {String}      Scaled hex color
	 */
	if(arguments.length < 3)
	  throw "Insufficient number of parameters passed.";
	
	var a = 0, b = 100;
	perc = a + (perc - min)*(b-a)/(max - min);
	
	var r, g, b = 0;
	if(perc < 50) {
	  r = 255;
	  g = Math.round(5.1 * perc);
	}
	else {
	  g = 255;
	  r = Math.round(510 - 5.10 * perc);
        }
        var h = r * 0x10000 + g * 0x100 + b * 0x1;
	return '#' + ('000000' + h.toString(16)).slice(-6);
      }

      var now_showing=0;

      /**
       * Load the csv data containing (mean) scenic rating per point. We need to convert this to 
       * a geojson format so that we can apply it to the leaflet map
       */
      
      d3.csv('mean_scenic_rating_locid2.csv', function (error, scenic) {
	function reformat(array) {
	  var data = [];
	  array.map(function (d, i) {
	    data.push({
	      id: i,
	      type: "Feature",
	      properties: {
		scenic_rating: d.mean_rating_per_locid,
	      },
	      geometry: {
		coordinates: [+d.lon, +d.lat],
		type: "Point"
	      }
	    });
	  });
	  return data;
	}
        var geoData = { type: "FeatureCollection", features: reformat(scenic) };
        console.log("geodata", geoData);

        var leafletMap = L.map('map', {preferCanvas:true}).setView([51.505, -0.09], 13);
        var base = new L.StamenTileLayer("toner-lite");
        leafletMap.addLayer(base);

        var renderer = L.tileLayer.canvas({ padding: 0.5 });
        pointsLayer = L.geoJson(geoData, {
	  pointToLayer: function (feature, latlng) {
	    geojsonMarkerOptions = {
	      radius: 3,
	      fillColor: percToColour(feature.properties.scenic_rating, 1.61, 6.34),
	      color: "white",
	      weight: 1,
	      opacity: 1,
              fillOpacity: 0.8,
              renderer: renderer
	    }
	    return L.circleMarker(latlng, geojsonMarkerOptions);
          }
        });
        console.log("points layer", pointsLayer);

        /**
         * Now load the data containing values/scores for multiple variables per LSOA, so 
         * this information can be displayed as we rollover and click on an LSOA
         */

        function highlightFeature(e) { // set style and highlighting for LSOA that mouse is over
          var layer = e.target;
          layer.setStyle({
            weight: 1,
            opacity: 1,
            color: '#acadc1',
            dashArray: '',
            fillOpacity: .2
          });
          if (!L.Browser.ie && !L.Browser.opera) {
            layer.bringToFront();
          }
          info.update(layer.feature.properties);
        }

        var lsoaBoundaries;
        function resetHighlight(e) { // function for mouseout
          lsoaBoundaries.resetStyle(e.target);
          info.update();
        }

        function displayInfo(e) {
          var layer = e.target;
          now_showing=layer.feature.properties;
          info.update(layer.feature.properties);
        }
        
        function onEachFeature(feature, layer) {
          layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: displayInfo
          });
        }

	$.getJSON("lsoa_boundaries_joined_with_crime_data.geojson", function(json){
          console.log("lsoa crime data json", json);

          // LSOA boundaries layer, highlight boundaries as user scrolls over
          lsoaBoundaries = L.geoJson(json, {
            style: function (feature) {
              return {
                fillColor: '#acadc1',
                weight: 1,
                opacity: 0,
                color: 'white',
                fillOpacity: 0
              };
            },
            onEachFeature: onEachFeature
          }).addTo(leafletMap);
          console.log("LSOA boundaries", lsoaBoundaries);

          // Scenery layer displaying mean scenic rating per LSOA data
          var sceneryLayer = L.geoJson(json, {
            style: function (feature) {
              return {
                fillColor: percToColour(feature.properties.scenic_rating, 2.16, 4.84),
                weight: 1.1,
                opacity: 0,
                color: 'white',
                dashArray: '1',
                fillOpacity: 0.4
              }; 
            }
          });
          console.log("Scenery layer", sceneryLayer);

          // optionally switch between displaying scenic rating as points vs mean per LSOA
          var overlayMaps = {
            "Mean Scenic Ratings per LSOA": sceneryLayer,
            "Scenic Points": pointsLayer
          };
          L.control.layers(null, overlayMaps, {position: 'bottomleft', collapsed: false}).addTo(leafletMap);
          leafletMap.on("overlayadd", function (event) {
            lsoaBoundaries.bringToFront(); // keep lsoa boundary information (including health, income scores etc.) at the front
          });
          leafletMap.attributionControl.addAttribution('Scenic Data &copy; <a href="http://scenicornot.datasciencelab.co.uk/">Scenic-Or-Not</a>');
        });

        /**
         * Next, add info (of scenic ratings and deprivation indices scores) to show when particular LSOA is clicked on
         */
        
        // custom info control
        var info = L.control();
        info.onAdd = function (map) {
          this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
          this.update();
          return this._div;
        };

        // method to update the control based on feature properties passed
        info.update = function (props) {
          var rollover_html="";
          if ((!props)&&(!now_showing)) {
            rollover_html="<h4>Click on any area <br />to see region info</h4>";
          }
          else if ((!props)&&(now_showing))
          {
            rollover_html+='<b>Area: '+now_showing.lsoa11cd+' ('+now_showing.lsoa11nm+')</b><br />Scenicness<br />' 
              +'<div class="band" style="width:'+parseInt(160-now_showing.scenic_rating*10*1.6)+'px; border-left: '
              +parseInt(now_showing.scenic_rating*10*1.6)+'px solid #a42e3d">&nbsp;</div>'
              +'Health<br />'
              +'<div class="band" style="width:'+parseInt(160-getHealthBar(now_showing.deprivation_health_deprivation_and_disability_score)*10*1.6)+'px; border-left: '
              +parseInt(getHealthBar(now_showing.deprivation_health_deprivation_and_disability_score)*10*1.6)+'px solid #a42e3d">&nbsp;</div>Income<br />'
              +'<div class="band" style="width:'+parseInt(160-getIncomeBar(now_showing.deprivation_income_score_rate)*10*1.6)+'px; border-left: '
              +parseInt(getIncomeBar(now_showing.deprivation_income_score_rate)*10*1.6)+'px solid #a42e3d">&nbsp;</div>'
              +'Employment<br />'
              +'<div class="band" style="width:'+parseInt(160-getEmploymentBar(now_showing.deprivation_employment_score_rate)*10*1.6)+'px; border-left: '
              +parseInt(getEmploymentBar(now_showing.deprivation_employment_score_rate)*10*1.6)+'px solid #a42e3d">&nbsp;</div>';
          }
          else if ((props)&&(!now_showing)) {
            rollover_html+="<h4>Show info for "+props.lsoa11cd+' ('+props.lsoa11nm+")</h4>";	
          }
          else {
            rollover_html+='<h4>Show info for ' + props.lsoa11cd +' ('+props.lsoa11nm+') next?</h4>';
            rollover_html+='<br /><b>Area: '+now_showing.lsoa11cd+' ('+now_showing.lsoa11nm+')</b><br />Scenicness<br />' 
              +'<div class="band" style="width:'+parseInt(160-now_showing.scenic_rating*10*1.6)+ 'px; border-left: '
              +parseInt(now_showing.scenic_rating*10*1.6)+'px solid #a42e3d">&nbsp;</div>'
              +'Health<br />'
              +'<div class="band" style="width:'+parseInt(160-getHealthBar(now_showing.deprivation_health_deprivation_and_disability_score)*10*1.6)+'px; border-left: '
              +parseInt(getHealthBar(now_showing.deprivation_health_deprivation_and_disability_score)*10*1.6)+'px solid #a42e3d">&nbsp;</div>Income<br />'
              +'<div class="band" style="width:'+parseInt(160-getIncomeBar(now_showing.deprivation_income_score_rate)*10*1.6)+'px; border-left: '
              +parseInt(getIncomeBar(now_showing.deprivation_income_score_rate)*10*1.6)+'px solid #a42e3d">&nbsp;</div>'
              +'Employment<br />'
              +'<div class="band" style="width:'+parseInt(160-getEmploymentBar(now_showing.deprivation_employment_score_rate)*10*1.6)+'px; border-left: '
              +parseInt(getEmploymentBar(now_showing.deprivation_employment_score_rate)*10*1.6)+'px solid #a42e3d">&nbsp;</div>';
          }
          this._div.innerHTML =  rollover_html;
        };
        info.addTo(leafletMap);

        function getIncomeBar(inc_rate) {
          /**
           * Scale a given income rate to be between 0, and 10, according
           * to the max and min in the dataset (.5 and 0, respectively).
           *
           * @param  {Number} inc_rate Income rate to scale
           * @return {Number}          Scaled income rate 
           */
          var a = 0, b = 10;
          return a + (inc_rate - 0)*(b-a)/(.5 - 0);
        }
        function getHealthBar(h_score) {
          /**
           * Scale a given health score to be between 0, and 10, according
           * to the max and min in the dataset (1.8 and -3.2, respectively).
           *
           * @param  {Number} h_score  Income rate to scale
           * @return {Number}          Scaled health score
           */
          var a = 0, b = 10;
          return a + ((h_score + 3.2) - 0)*(b-a)/((1.8+3.2) - 0);
        }
        function getEmploymentBar(e_score) {
          /**
           * Scale a given employment score to be between 0, and 10, according
           * to the max and min in the dataset (.4 and 0, respectively).
           *
           * @param  {Number} e_score  Employment score to scale
           * @return {Number}          Scaled employment score
           */          
          var a = 0, b = 10;
          return a + (e_score - 0)*(b-a)/(.4 - 0);
        }
        
        // scenic rating colour scale legend
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
          var div = L.DomUtil.create('div', 'info legend');
          div.innerHTML = "Scenic Rating Scale";
          var legend_svg = d3.select(div).append('svg');
          var defs = legend_svg.append("defs");

          var linearGradient = defs.append("linearGradient")
              .attr("id", "linear-gradient");

          // set the color for the start (0%) and end (100%)
          linearGradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#ff0000");
          linearGradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#00ff00");

          legend_svg.append("rect")
            .attr("width", 200)
            .attr("height", 35)
            .style("fill", "url(#linear-gradient)");
          //TODO: add text to colour legend
          return div;
        };
        legend.addTo(leafletMap);
      });
      </script>
  </body>
</html>
